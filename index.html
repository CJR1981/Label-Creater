<!DOCTYPE html>

<html>
<head>
    <meta charset="UTF-8">
    <title>C-Base Label Generator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .box {
            background: white;
            padding: 30px;
            margin: 20px 0;
            border-radius: 8px;
            border-left: 5px solid #0066cc;
        }
        h1 { color: #003d7a; }
        h2 { color: #0066cc; font-size: 18px; margin-bottom: 15px; }
        input[type="file"], input[type="date"], select {
            padding: 12px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 5px;
            margin: 10px 0;
        }
        input[type="file"] { width: 100%; }
        button {
            padding: 15px 30px;
            font-size: 16px;
            font-weight: bold;
            background: #0066cc;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px 10px 0;
        }
        button:hover { background: #0052a3; }
        .big-button {
            background: #00cc66;
            font-size: 20px;
            padding: 20px 40px;
            width: 100%;
        }
        .big-button:hover { background: #00a352; }
        .status {
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
            display: none;
        }
        .info { background: #e3f2fd; color: #1976d2; }
        .success { background: #e8f5e9; color: #388e3c; }
        .error { background: #ffebee; color: #d32f2f; }
        .preview {
            background: #fff3cd;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .preview-value {
            font-size: 24px;
            font-weight: bold;
            color: #003d7a;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <h1>‚úàÔ∏è Flight Label Generator</h1>
    <p>Upload C-Base PDF, set date, download labels for Zebra printer</p>

```
<div id="statusBox" class="status"></div>

<div class="box">
    <h2>Step 1: Upload C-Base PDF</h2>
    <input type="file" id="pdfInput" accept=".pdf">
</div>

<div class="box">
    <h2>Step 2: Set Flight Date</h2>
    <input type="date" id="dateInput">
    <select id="formatSelect">
        <option value="full">Full (January 10, 2026)</option>
        <option value="short">Short (Jan 10, 2026)</option>
        <option value="numeric">Numeric (01/10/2026)</option>
    </select>
    <button id="todayBtn">Use Today</button>
    
    <div class="preview" id="previewBox" style="display:none;">
        <strong>Date on labels:</strong>
        <div class="preview-value" id="previewText"></div>
    </div>
</div>

<div class="box">
    <h2>Step 3: Generate Labels</h2>
    <button id="generateBtn" class="big-button">üè∑Ô∏è Generate & Download Labels</button>
    <div id="resultBox" style="display:none; margin-top:20px;">
        <strong>‚úÖ Generated <span id="countText">0</span> labels</strong>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    
    let labelDate = '';
    
    function showStatus(msg, type) {
        const box = document.getElementById('statusBox');
        box.textContent = msg;
        box.className = 'status ' + type;
        box.style.display = 'block';
    }
    
    document.getElementById('todayBtn').onclick = function() {
        const now = new Date();
        const y = now.getFullYear();
        const m = String(now.getMonth() + 1).padStart(2, '0');
        const d = String(now.getDate()).padStart(2, '0');
        document.getElementById('dateInput').value = y + '-' + m + '-' + d;
        updatePreview();
    };
    
    function updatePreview() {
        const val = document.getElementById('dateInput').value;
        const fmt = document.getElementById('formatSelect').value;
        
        if (!val) return;
        
        const p = val.split('-');
        const dt = new Date(p[0], p[1]-1, p[2]);
        
        const mf = ['January','February','March','April','May','June','July','August','September','October','November','December'];
        const ms = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
        
        const mo = dt.getMonth();
        const da = dt.getDate();
        const yr = dt.getFullYear();
        
        if (fmt === 'full') {
            labelDate = mf[mo] + ' ' + da + ', ' + yr;
        } else if (fmt === 'short') {
            labelDate = ms[mo] + ' ' + da + ', ' + yr;
        } else {
            labelDate = String(mo+1).padStart(2,'0') + '/' + String(da).padStart(2,'0') + '/' + yr;
        }
        
        document.getElementById('previewBox').style.display = 'block';
        document.getElementById('previewText').textContent = labelDate;
    }
    
    document.getElementById('dateInput').onchange = updatePreview;
    document.getElementById('formatSelect').onchange = updatePreview;
    
    document.getElementById('generateBtn').onclick = async function() {
        const fileEl = document.getElementById('pdfInput');
        const dateEl = document.getElementById('dateInput');
        
        if (!fileEl.files[0]) {
            alert('Please upload a PDF file first');
            return;
        }
        
        if (!dateEl.value) {
            alert('Please select a date');
            return;
        }
        
        if (!labelDate) updatePreview();
        
        try {
            showStatus('Reading PDF...', 'info');
            
            const file = fileEl.files[0];
            const buf = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({data: buf}).promise;
            
            showStatus('Extracting text from ' + pdf.numPages + ' pages...', 'info');
            
            let txt = '';
            for (let i = 1; i <= pdf.numPages; i++) {
                const pg = await pdf.getPage(i);
                const con = await pg.getTextContent();
                const t = con.items.map(function(x) { return x.str; }).join('\n');
                txt += t + '\n';
            }
            
            showStatus('Finding cart data...', 'info');
            
            const carts = [];
            const parts = txt.split('Report Date');
            
            for (let k = 0; k < parts.length - 1; k++) {
                const lines = parts[k].split('\n').map(function(s) { return s.trim(); });
                
                let desc = '';
                let stow = '';
                
                for (let i = 0; i < lines.length; i++) {
                    if (lines[i] === 'Description') {
                        for (let j = i + 1; j < i + 5 && j < lines.length; j++) {
                            const d = lines[j];
                            if (d && d !== 'Aircraft' && d !== 'Loading List' && d !== 'Page' && 
                                !d.startsWith('788') && d.length > 3) {
                                desc = d;
                                break;
                            }
                        }
                    }
                    
                    if (lines[i].indexOf('Stowage Position') >= 0) {
                        for (let j = i + 1; j < i + 5 && j < lines.length; j++) {
                            const m = lines[j].match(/G\d+-\d+\s*[A-Z]?/);
                            if (m) {
                                stow = m[0].trim();
                                break;
                            }
                        }
                    }
                }
                
                if (desc && stow) {
                    carts.push({desc: desc, stow: stow});
                }
            }
            
            if (carts.length === 0) {
                throw new Error('No cart data found in PDF');
            }
            
            showStatus('Creating ' + carts.length + ' label files...', 'info');
            
            const zip = new JSZip();
            
            for (let i = 0; i < carts.length; i++) {
                const c = carts[i];
                const zpl = makeZPL(c.desc, c.stow, labelDate);
                const fn = 'Label_' + c.stow.replace(/\s+/g, '_') + '.zpl';
                zip.file(fn, zpl);
            }
            
            const blob = await zip.generateAsync({type: 'blob'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'Flight_Labels_' + carts.length + '.zip';
            a.click();
            
            document.getElementById('resultBox').style.display = 'block';
            document.getElementById('countText').textContent = carts.length;
            showStatus('‚úÖ Downloaded ' + carts.length + ' labels successfully!', 'success');
            
        } catch (err) {
            showStatus('‚ùå Error: ' + err.message, 'error');
            console.error(err);
        }
    };
    
    function makeZPL(description, stowage, date) {
        let l1 = '';
        let l2 = '';
        
        if (description.length > 26) {
            const words = description.split(' ');
            let cur = '';
            for (let i = 0; i < words.length; i++) {
                const test = cur + (cur ? ' ' : '') + words[i];
                if (test.length <= 26) {
                    cur = test;
                } else {
                    if (!l1) {
                        l1 = cur;
                        cur = words[i];
                    } else {
                        l2 = cur;
                        break;
                    }
                }
            }
            if (!l2) l2 = cur;
            if (!l1) l1 = description;
        } else {
            l1 = description;
        }
        
        return '^XA\n' +
            '^CI28\n' +
            '~SD15\n' +
            '^PW406\n' +
            '^LL609\n' +
            '\n' +
            '^FO0,0^GB406,110,110^FS\n' +
            '\n' +
            '^CF0,70\n' +
            '^FO15,20^FDFLIGHT^FS\n' +
            '\n' +
            '^CF0,30\n' +
            '^FO15,130^FD' + date + '^FS\n' +
            '\n' +
            '^CF0,32\n' +
            '^FO15,175^FDROUTE | A/C^FS\n' +
            '\n' +
            '^CF0,30\n' +
            '^FO15,230^FD' + l1 + '^FS\n' +
            '^FO15,270^FD' + l2 + '^FS\n' +
            '\n' +
            '^CF0,65\n' +
            '^FO15,520^FD' + stowage + '^FS\n' +
            '\n' +
            '^XZ';
    }
    
    window.onload = function() {
        const now = new Date();
        const y = now.getFullYear();
        const m = String(now.getMonth() + 1).padStart(2, '0');
        const d = String(now.getDate()).padStart(2, '0');
        document.getElementById('dateInput').value = y + '-' + m + '-' + d;
        updatePreview();
    };
</script>
```

</body>
</html>